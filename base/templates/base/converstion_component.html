<div class="room__conversation">
    <div class="threads scroll" id="messages-list">
        {% for message in room.message_set.all %}
          {% include 'base/_message.html' %}
        {% empty %}
            <span>No Messages Yet !</span>
        {% endfor %}
    </div>
</div>


{% if request.user.is_authenticated %}
  {% block extra_scripts %}
    <script>
      // ==================== Message Reaction  ===================
      messagesList = document.getElementById("messages-list")

      messagesList.querySelectorAll(".item-reaction").forEach(reaction => {
        reaction.addEventListener("click", (e) => {
          
          console.log(e)
          console.log("reation_type_id",e.target.id)
          console.log("message_or_reply_id",e.target.dataset.message)

          reaction_type_id = e.target.id
          message_id = e.target.dataset.message

          data = {
            reaction_type_id:reaction_type_id
          }

          // message/<int:pk>/reaction
          const URL = `/message/${message_id}/reaction`

          fetch(URL,{
            method:"POST",
            body: JSON.stringify(data),
            headers: { 
              "X-CSRFToken": '{{csrf_token}}',
              'content-type': 'application/json',
            },
          })
            .then(response => response.json())
            .then(data => {
              console.log(data)
              // update html --- m-1-count-1
              countSpan = document.getElementById(`m-${message_id}-count-${reaction_type_id}`)

              if(data.operation === 'added'){
                countSpan.innerHTML = parseInt(countSpan.innerText) + 1
              }else if(data.operation === 'removed'){
                countSpan.innerHTML = parseInt(countSpan.innerText) - 1
              }else{
                // do nothing
              }

            }).catch(e => {
              console.log(e)
            })

        })
      })

      document.addEventListener(
            "click",
            function(event) {
                var target = event.target;
                var replyForm;
                if (target.matches("[data-toggle='reply-form']")) {
                    replyForm = document.getElementById(target.getAttribute("data-target"));
                    replyForm.classList.toggle("d-none");
                }
            },
            false
        );
    </script>
  {% endblock %}
{% endif %}
